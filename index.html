<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”ä»·é›·è¾¾ Â· å…¨ç½‘æ¯”ä»·åŠ©æ‰‹</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --ink: #1a1a1e;
  --ink2: #2c2c34;
  --ink3: #3e3e4a;
  --paper: #f5f4ef;
  --paper2: #eeede6;
  --paper3: #e5e3d8;
  --accent: #c8341a;
  --accent-light: rgba(200,52,26,0.1);
  --accent2: #d4860a;
  --green: #2a7a4b;
  --green-light: rgba(42,122,75,0.12);
  --jd: #c8341a;
  --mt: #f5a800;
  --dd: #1677ff;
  --hm: #e63312;
  --text: #1a1a1e;
  --muted: #7a7a85;
  --border: rgba(26,26,30,0.1);
  --shadow: 0 2px 12px rgba(26,26,30,0.08);
  --shadow-lg: 0 8px 40px rgba(26,26,30,0.14);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--paper);
  color: var(--text);
  font-family: 'Noto Sans SC', sans-serif;
  min-height: 100vh;
  font-size: 14px;
}

/* Grain texture overlay */
body::before {
  content:'';
  position: fixed;
  inset:0;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 999;
}

/* Layout */
.shell {
  display: grid;
  grid-template-columns: 260px 1fr;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  background: var(--ink);
  color: #e8e8ee;
  padding: 0;
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar::-webkit-scrollbar { width: 0; }

.logo-area {
  padding: 28px 24px 24px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.logo-text {
  font-family: 'Noto Serif SC', serif;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: 0.5px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-radar {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.logo-sub {
  font-size: 11px;
  color: rgba(255,255,255,0.3);
  margin-top: 4px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 1px;
}

/* Platform status */
.platforms-area {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.area-label {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.25);
  margin-bottom: 12px;
  font-family: 'JetBrains Mono', monospace;
}

.platform-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  cursor: pointer;
}

.platform-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.platform-dot.online { animation: blink 2s ease-in-out infinite; }

@keyframes blink {
  0%,100% { opacity:1; }
  50% { opacity:0.4; }
}

.platform-row-name {
  flex: 1;
  font-size: 13px;
  color: rgba(255,255,255,0.7);
}

.platform-row-status {
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: rgba(255,255,255,0.25);
}

/* Watchlist sidebar */
.watchlist-area {
  padding: 20px 24px;
  flex: 1;
}

.watchlist-empty {
  font-size: 12px;
  color: rgba(255,255,255,0.2);
  text-align: center;
  padding: 20px 0;
  line-height: 2;
}

.watch-item {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  position: relative;
}

.watch-item:hover {
  background: rgba(255,255,255,0.07);
  border-color: rgba(255,255,255,0.12);
}

.watch-item-name {
  font-size: 12px;
  color: rgba(255,255,255,0.75);
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.watch-item-price {
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 600;
  color: #fff;
}

.watch-item-meta {
  font-size: 10px;
  color: rgba(255,255,255,0.3);
  margin-top: 3px;
}

.watch-item-alert {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 11px;
}

.watch-remove {
  position: absolute;
  bottom: 8px;
  right: 10px;
  font-size: 10px;
  color: rgba(255,255,255,0.2);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 3px;
  transition: color 0.15s;
}

.watch-remove:hover { color: var(--accent); }

/* Main area */
.main {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow: hidden;
}

/* Top bar */
.topbar {
  padding: 20px 36px;
  border-bottom: 1px solid var(--border);
  background: var(--paper);
  position: sticky;
  top: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 16px;
}

.search-wrap {
  flex: 1;
  position: relative;
}

.search-wrap::before {
  content: 'ğŸ”';
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  pointer-events: none;
}

.search-inp {
  width: 100%;
  background: var(--paper2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 11px 16px 11px 40px;
  font-size: 14px;
  font-family: 'Noto Sans SC', sans-serif;
  color: var(--text);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.search-inp:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
  background: #fff;
}

.search-inp::placeholder { color: var(--muted); }

.search-go {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 11px 22px;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Noto Sans SC', sans-serif;
  cursor: pointer;
  white-space: nowrap;
  transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
  flex-shrink: 0;
}

.search-go:hover { background: #b02d16; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(200,52,26,0.35); }
.search-go:active { transform: translateY(0); }

/* Content area */
.content {
  padding: 28px 36px;
  flex: 1;
}

/* Quick tags */
.quick-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 28px;
}

.qtag {
  padding: 5px 13px;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
  background: #fff;
  user-select: none;
}

.qtag:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* State panels */
.panel { display: none; }
.panel.active { display: block; }

/* Loading */
#panelLoading {
  padding: 40px 0;
}

.loading-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.loading-card {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}

.loading-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 900;
  color: #fff;
  position: relative;
  overflow: hidden;
}

.loading-icon::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
  animation: sheen 1.4s infinite;
}

@keyframes sheen {
  0% { transform: translateX(-150%) rotate(20deg); }
  100% { transform: translateX(150%) rotate(20deg); }
}

.loading-icon.jd { background: var(--jd); }
.loading-icon.mt { background: var(--mt); }
.loading-icon.dd { background: var(--dd); }
.loading-icon.hm { background: var(--hm); }

.loading-status {
  font-size: 12px;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
}

.loading-status.done { color: var(--green); }

.loading-bar {
  height: 3px;
  background: var(--paper2);
  border-radius: 2px;
  overflow: hidden;
  max-width: 400px;
  margin: 0 auto;
}

.loading-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 2px;
  width: 0%;
  transition: width 0.5s ease;
}

/* Results layout */
.results-kw {
  font-family: 'Noto Serif SC', serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--ink);
}

.results-kw span { color: var(--accent); }

.results-meta {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 24px;
  font-family: 'JetBrains Mono', monospace;
}

.results-grid {
  display: grid;
  grid-template-columns: 1fr 360px;
  gap: 20px;
  align-items: start;
}

/* Platform cards grid */
.platform-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.p-card {
  background: #fff;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 18px;
  cursor: pointer;
  transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.3s ease backwards;
}

.p-card:nth-child(2) { animation-delay: 0.04s; }
.p-card:nth-child(3) { animation-delay: 0.08s; }
.p-card:nth-child(4) { animation-delay: 0.12s; }

@keyframes fadeUp {
  from { opacity:0; transform: translateY(10px); }
  to { opacity:1; transform: translateY(0); }
}

.p-card.winner {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.p-card.winner::before {
  content: 'æœ€ä½ä»·';
  position: absolute;
  top: 0;
  right: 0;
  background: var(--accent);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 0 10px 0 8px;
  letter-spacing: 0.5px;
}

.p-card:hover:not(.winner) { border-color: rgba(26,26,30,0.2); box-shadow: var(--shadow); transform: translateY(-2px); }

.p-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.p-logo {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 900;
  color: #fff;
  flex-shrink: 0;
}

.p-logo.jd { background: var(--jd); }
.p-logo.mt { background: var(--mt); color: #5a3800; }
.p-logo.dd { background: var(--dd); }
.p-logo.hm { background: var(--hm); }

.p-name { font-size: 12px; color: var(--muted); font-weight: 500; }

.p-price-main {
  font-family: 'JetBrains Mono', monospace;
  font-size: 26px;
  font-weight: 600;
  color: var(--ink);
  line-height: 1;
  margin-bottom: 4px;
}

.p-price-main.lowest { color: var(--accent); }
.p-price-main .sym { font-size: 14px; }

.p-original {
  font-size: 12px;
  color: var(--muted);
  text-decoration: line-through;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 6px;
}

.p-product-name {
  font-size: 12px;
  color: var(--ink2);
  margin-bottom: 10px;
  line-height: 1.5;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.p-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-bottom: 12px;
}

.tag {
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 500;
}

.tag-speed { background: rgba(212,134,10,0.1); color: var(--accent2); }
.tag-coupon { background: var(--accent-light); color: var(--accent); }
.tag-cert { background: var(--green-light); color: var(--green); }

.p-footer {
  display: flex;
  align-items: center;
  gap: 8px;
}

.p-buy-btn {
  flex: 1;
  background: var(--ink);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 8px;
  font-size: 12px;
  font-weight: 700;
  font-family: 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: background 0.15s;
  text-align: center;
}

.p-buy-btn:hover { background: var(--ink3); }

.p-card.winner .p-buy-btn { background: var(--accent); }
.p-card.winner .p-buy-btn:hover { background: #b02d16; }

.p-watch-btn {
  width: 32px;
  height: 32px;
  border: 1.5px solid var(--border);
  background: transparent;
  border-radius: 7px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.15s;
  flex-shrink: 0;
}

.p-watch-btn:hover { border-color: var(--accent); }
.p-watch-btn.watching { border-color: var(--accent); background: var(--accent-light); }

/* Side panel */
.side-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Best deal summary */
.deal-box {
  background: var(--ink);
  border-radius: 12px;
  padding: 20px;
  color: #fff;
  animation: fadeUp 0.3s ease backwards;
}

.deal-box-label {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.3);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 12px;
}

.deal-price {
  font-family: 'JetBrains Mono', monospace;
  font-size: 40px;
  font-weight: 600;
  line-height: 1;
  color: #fff;
  margin-bottom: 4px;
}

.deal-price .sym { font-size: 22px; }

.deal-saving {
  font-size: 13px;
  color: #7deba0;
  margin-bottom: 16px;
  font-family: 'JetBrains Mono', monospace;
}

.deal-platform {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.deal-platform-badge {
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
}

.deal-name {
  font-size: 13px;
  color: rgba(255,255,255,0.65);
  margin-bottom: 16px;
  line-height: 1.6;
}

.deal-cta {
  width: 100%;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
}

.deal-cta:hover { background: #b02d16; transform: translateY(-1px); }

/* Price bar comparison */
.bars-box {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px;
  animation: fadeUp 0.3s ease 0.1s backwards;
}

.box-title {
  font-size: 11px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 14px;
}

.bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.bar-plat {
  width: 28px;
  height: 20px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  font-weight: 900;
  color: #fff;
  flex-shrink: 0;
}

.bar-plat.mt-bar { color: #5a3800; }

.bar-track {
  flex: 1;
  height: 20px;
  background: var(--paper2);
  border-radius: 4px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding: 0 8px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  white-space: nowrap;
  transition: width 0.8s cubic-bezier(0.16,1,0.3,1);
  color: #fff;
}

.bar-fill.mt-fill { color: #5a3800; }
.bar-fill.winner-fill { box-shadow: inset 0 0 0 1.5px rgba(0,0,0,0.15); }

/* History chart */
.chart-box {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px;
  animation: fadeUp 0.3s ease 0.05s backwards;
}

.chart-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 14px;
  background: var(--paper2);
  border-radius: 7px;
  padding: 3px;
}

.ctab {
  flex: 1;
  text-align: center;
  padding: 5px;
  font-size: 11px;
  border-radius: 5px;
  cursor: pointer;
  color: var(--muted);
  transition: all 0.15s;
  font-family: 'JetBrains Mono', monospace;
}

.ctab.active {
  background: #fff;
  color: var(--text);
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

.chart-canvas-wrap {
  position: relative;
  height: 160px;
}

/* Alert modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,26,30,0.5);
  backdrop-filter: blur(4px);
  z-index: 200;
  align-items: center;
  justify-content: center;
}

.modal-overlay.show { display: flex; }

.modal {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  width: 360px;
  box-shadow: var(--shadow-lg);
  animation: popIn 0.25s cubic-bezier(0.16,1,0.3,1);
}

@keyframes popIn {
  from { opacity:0; transform: scale(0.9) translateY(10px); }
  to { opacity:1; transform: scale(1) translateY(0); }
}

.modal-title {
  font-family: 'Noto Serif SC', serif;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.modal-sub {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 20px;
  line-height: 1.6;
}

.modal-field {
  margin-bottom: 14px;
}

.modal-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--ink2);
  margin-bottom: 6px;
  display: block;
}

.modal-inp {
  width: 100%;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text);
  outline: none;
  background: var(--paper2);
  transition: border-color 0.2s;
}

.modal-inp:focus { border-color: var(--accent); background: #fff; }

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.modal-cancel {
  flex: 1;
  padding: 11px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: transparent;
  font-size: 14px;
  font-family: 'Noto Sans SC', sans-serif;
  cursor: pointer;
  color: var(--text);
  transition: border-color 0.15s;
}

.modal-cancel:hover { border-color: var(--ink3); }

.modal-confirm {
  flex: 2;
  padding: 11px;
  background: var(--accent);
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Noto Sans SC', sans-serif;
  color: #fff;
  cursor: pointer;
  transition: background 0.15s;
}

.modal-confirm:hover { background: #b02d16; }

/* Toast */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  background: var(--ink);
  color: #fff;
  border-radius: 10px;
  padding: 14px 18px;
  font-size: 13px;
  max-width: 280px;
  transform: translateY(20px);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  z-index: 300;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  box-shadow: var(--shadow-lg);
}

.toast.show { transform: translateY(0); opacity: 1; }

.toast-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

.toast-body {}

.toast-title { font-weight: 700; margin-bottom: 2px; }

.toast-msg { font-size: 12px; color: rgba(255,255,255,0.6); }

/* Welcome */
#panelWelcome {
  padding: 60px 0 40px;
}

.welcome-hero {
  text-align: center;
  max-width: 500px;
  margin: 0 auto;
}

.welcome-icon { font-size: 56px; margin-bottom: 20px; }

.welcome-title {
  font-family: 'Noto Serif SC', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--ink);
  margin-bottom: 12px;
  line-height: 1.4;
}

.welcome-sub {
  font-size: 14px;
  color: var(--muted);
  line-height: 1.8;
  margin-bottom: 32px;
}

.feature-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  text-align: center;
  margin-top: 16px;
}

.feature-item {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 10px;
}

.feature-icon { font-size: 22px; margin-bottom: 8px; }

.feature-name { font-size: 12px; font-weight: 600; margin-bottom: 4px; }

.feature-desc { font-size: 11px; color: var(--muted); line-height: 1.5; }

/* API guide card */
.api-guide {
  background: var(--paper2);
  border: 1.5px dashed var(--border);
  border-radius: 12px;
  padding: 20px 24px;
  margin-top: 20px;
}

.api-guide-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--ink2);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.api-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
}

.api-row:last-child { border-bottom: none; }

.api-plat-tag {
  width: 46px;
  padding: 3px 0;
  border-radius: 4px;
  text-align: center;
  font-size: 10px;
  font-weight: 900;
  color: #fff;
  flex-shrink: 0;
}

.api-endpoint {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--ink2);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.api-status {
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 10px;
  flex-shrink: 0;
  font-family: 'JetBrains Mono', monospace;
}

.api-status.official { background: var(--green-light); color: var(--green); }
.api-status.reverse { background: rgba(212,134,10,0.1); color: var(--accent2); }

/* Responsive */
@media (max-width: 900px) {
  .shell { grid-template-columns: 1fr; }
  .sidebar { position: relative; height: auto; flex-direction: row; overflow-x: auto; }
  .results-grid { grid-template-columns: 1fr; }
  .platform-cards { grid-template-columns: 1fr; }
  .feature-row { grid-template-columns: 1fr 1fr; }
  .topbar { padding: 14px 20px; }
  .content { padding: 20px; }
  .loading-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<div class="shell">

<!-- â”€â”€ SIDEBAR â”€â”€ -->
<aside class="sidebar">
  <div class="logo-area">
    <div class="logo-text">
      <div class="logo-radar">ğŸ“¡</div>
      æ¯”ä»·é›·è¾¾
    </div>
    <div class="logo-sub">PRICE RADAR v2.0</div>
  </div>

  <div class="platforms-area">
    <div class="area-label">æ•°æ®æºçŠ¶æ€</div>
    <div class="platform-row">
      <div class="platform-dot online" style="background:#c8341a"></div>
      <div class="platform-row-name">äº¬ä¸œè‡ªè¥</div>
      <div class="platform-row-status">ç½‘é¡µç‰ˆ âœ“</div>
    </div>
    <div class="platform-row">
      <div class="platform-dot online" style="background:#f5a800"></div>
      <div class="platform-row-name">ç¾å›¢é—ªè´­</div>
      <div class="platform-row-status">ä»…Appç«¯</div>
    </div>
    <div class="platform-row">
      <div class="platform-dot online" style="background:#1677ff"></div>
      <div class="platform-row-name">å®å’šä¹°èœ</div>
      <div class="platform-row-status">ä»…Appç«¯</div>
    </div>
    <div class="platform-row">
      <div class="platform-dot online" style="background:#e63312"></div>
      <div class="platform-row-name">ç›’é©¬é²œç”Ÿ</div>
      <div class="platform-row-status">ä»…Appç«¯</div>
    </div>
  </div>

  <div class="watchlist-area">
    <div class="area-label">æˆ‘çš„æ”¶è— <span id="watchCount" style="color:rgba(255,255,255,0.4)">(0)</span></div>
    <div id="sidebarWatchlist">
      <div class="watchlist-empty">æš‚æ— æ”¶è—å•†å“<br>ç‚¹å‡» â˜† æ”¶è—å•†å“<br>å¯è®¾ç½®åˆ°ä»·æé†’</div>
    </div>
  </div>
</aside>

<!-- â”€â”€ MAIN â”€â”€ -->
<main class="main">

  <!-- Topbar search -->
  <div class="topbar">
    <div class="search-wrap">
      <input class="search-inp" id="searchInp" type="text" placeholder="æœç´¢å•†å“åç§°ï¼Œå¦‚ï¼šæœ‰æœºé¸¡è›‹ã€ä¸‰æ–‡é±¼ã€ç‰›å¥¶â€¦" />
    </div>
    <button class="search-go" onclick="doSearch()">å…¨ç½‘æ¯”ä»·</button>
  </div>

  <div class="content">

    <!-- Quick tags -->
    <div class="quick-row">
      <span class="qtag" onclick="qs('æœ‰æœºé¸¡è›‹')">ğŸ¥š æœ‰æœºé¸¡è›‹</span>
      <span class="qtag" onclick="qs('ç‰¹ä»‘è‹ç‰›å¥¶')">ğŸ¥› ç‰¹ä»‘è‹ç‰›å¥¶</span>
      <span class="qtag" onclick="qs('æŒªå¨ä¸‰æ–‡é±¼')">ğŸŸ æŒªå¨ä¸‰æ–‡é±¼</span>
      <span class="qtag" onclick="qs('çŒªè‚‰é‡Œè„Š')">ğŸ¥© çŒªè‚‰é‡Œè„Š</span>
      <span class="qtag" onclick="qs('ä¸¹ä¸œè‰è“')">ğŸ“ ä¸¹ä¸œè‰è“</span>
      <span class="qtag" onclick="qs('çŸ¿æ³‰æ°´')">ğŸ’§ çŸ¿æ³‰æ°´</span>
      <span class="qtag" onclick="qs('è“è“')">ğŸ« è“è“</span>
    </div>

    <!-- Welcome panel -->
    <div class="panel active" id="panelWelcome">
      <div class="welcome-hero">
        <div class="welcome-icon">ğŸ“¡</div>
        <div class="welcome-title">å…¨ç½‘æ¯”ä»·ï¼Œä¸€æœå³è¾¾</div>
        <div class="welcome-sub">åŒæ—¶æ¯”è¾ƒäº¬ä¸œã€ç¾å›¢é—ªè´­ã€å®å’šä¹°èœã€ç›’é©¬é²œç”Ÿçš„å®æ—¶ä»·æ ¼<br>è‡ªåŠ¨æ‰¾å‡ºå…¨ç½‘æœ€ä½ï¼Œæ”¯æŒä»·æ ¼å†å²èµ°åŠ¿ä¸åˆ°ä»·æé†’</div>
      </div>

      <div class="feature-row">
        <div class="feature-item">
          <div class="feature-icon">âš¡</div>
          <div class="feature-name">å¤šå¹³å°å¹¶å‘</div>
          <div class="feature-desc">4å¹³å°åŒæ—¶æŸ¥è¯¢<br>ç§’çº§å‡ºç»“æœ</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ“ˆ</div>
          <div class="feature-name">ä»·æ ¼èµ°åŠ¿</div>
          <div class="feature-desc">30å¤©å†å²ä»·æ ¼<br>ä½ä»·è¶‹åŠ¿ä¸€è§ˆ</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ””</div>
          <div class="feature-name">åˆ°ä»·æé†’</div>
          <div class="feature-desc">è®¾å®šç›®æ ‡ä»·<br>é™ä»·å³æ—¶é€šçŸ¥</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ”—</div>
          <div class="feature-name">ç›´è¾¾è´­ä¹°</div>
          <div class="feature-desc">ä¸€é”®è·³è½¬<br>æœ€ä½ä»·è´­ä¹°é¡µ</div>
        </div>
      </div>

      <!-- API info -->
      <div class="api-guide" style="max-width:600px; margin:28px auto 0;">
        <div class="api-guide-title">ğŸ”Œ å®˜æ–¹ API æ¥å…¥è¯´æ˜ï¼ˆå½“å‰ä¸ºæ¼”ç¤ºæ•°æ®ï¼‰</div>
        <div class="api-row">
          <div class="api-plat-tag" style="background:var(--jd)">äº¬ä¸œ</div>
          <div class="api-endpoint">union.jd.com Â· äº¬ä¸œè”ç›Ÿå•†å“æŸ¥è¯¢ API</div>
          <div class="api-status official">å®˜æ–¹æˆæƒ</div>
        </div>
        <div class="api-row">
          <div class="api-plat-tag" style="background:var(--mt);color:#5a3800">ç¾å›¢</div>
          <div class="api-endpoint">shangou.meituan.com Â· å•†å®¶å¼€æ”¾å¹³å°ï¼ˆä»…Appè´­ç‰©ï¼‰</div>
          <div class="api-status reverse">éœ€ä¼ä¸šèµ„è´¨</div>
        </div>
        <div class="api-row">
          <div class="api-plat-tag" style="background:var(--dd)">å®å’š</div>
          <div class="api-endpoint">dingdong.com Â· ç§»åŠ¨ç«¯APIæŠ“åŒ…ï¼ˆApp Onlyï¼‰</div>
          <div class="api-status reverse">é€†å‘æ¥å£</div>
        </div>
        <div class="api-row">
          <div class="api-plat-tag" style="background:var(--hm)">ç›’é©¬</div>
          <div class="api-endpoint">freshippo.com Â· é˜¿é‡Œç³»æ¥å£ï¼ˆApp Onlyï¼‰</div>
          <div class="api-status reverse">é€†å‘æ¥å£</div>
        </div>
      </div>
    </div>

    <!-- Loading panel -->
    <div class="panel" id="panelLoading">
      <div class="loading-grid">
        <div class="loading-card">
          <div class="loading-icon jd" id="li-jd">äº¬ä¸œ</div>
          <div class="loading-status" id="ls-jd">æŸ¥è¯¢ä¸­â€¦</div>
        </div>
        <div class="loading-card">
          <div class="loading-icon mt" id="li-mt">ç¾å›¢</div>
          <div class="loading-status" id="ls-mt">ç­‰å¾…ä¸­â€¦</div>
        </div>
        <div class="loading-card">
          <div class="loading-icon dd" id="li-dd">å®å’š</div>
          <div class="loading-status" id="ls-dd">ç­‰å¾…ä¸­â€¦</div>
        </div>
        <div class="loading-card">
          <div class="loading-icon hm" id="li-hm">ç›’é©¬</div>
          <div class="loading-status" id="ls-hm">ç­‰å¾…ä¸­â€¦</div>
        </div>
      </div>
      <div class="loading-bar"><div class="loading-fill" id="loadingFill"></div></div>
    </div>

    <!-- Results panel -->
    <div class="panel" id="panelResults">
      <div class="results-kw" id="resKw"></div>
      <div class="results-meta" id="resMeta"></div>

      <div class="results-grid">
        <!-- Left: platform cards + history chart -->
        <div>
          <div class="platform-cards" id="platformCards"></div>

          <!-- History price chart -->
          <div class="chart-box">
            <div class="box-title">ä»·æ ¼å†å²èµ°åŠ¿ï¼ˆ30å¤©ï¼‰</div>
            <div class="chart-tabs">
              <div class="ctab active" onclick="switchChart('all',this)">å…¨éƒ¨å¹³å°</div>
              <div class="ctab" onclick="switchChart('jd',this)">äº¬ä¸œ</div>
              <div class="ctab" onclick="switchChart('mt',this)">ç¾å›¢</div>
              <div class="ctab" onclick="switchChart('dd',this)">å®å’š</div>
              <div class="ctab" onclick="switchChart('hm',this)">ç›’é©¬</div>
            </div>
            <div class="chart-canvas-wrap">
              <canvas id="priceChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Right: deal box + bar chart -->
        <div class="side-panel">
          <div class="deal-box" id="dealBox"></div>

          <div class="bars-box" id="barsBox">
            <div class="box-title">ä»·æ ¼å¯¹æ¯”</div>
            <div id="barsContent"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /shell -->

<!-- Alert modal -->
<div class="modal-overlay" id="alertModal">
  <div class="modal">
    <div class="modal-title">ğŸ”” è®¾ç½®åˆ°ä»·æé†’</div>
    <div class="modal-sub" id="alertModalSub">å½“è¯¥å•†å“ä»·æ ¼ä½äºç›®æ ‡ä»·æ—¶ï¼Œæˆ‘ä»¬ä¼šæé†’ä½ </div>
    <div class="modal-field">
      <label class="modal-label">ç›®æ ‡ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
      <input class="modal-inp" id="alertPrice" type="number" placeholder="ä¾‹ï¼š25.00" step="0.1" />
    </div>
    <div class="modal-field">
      <label class="modal-label">é‚®ä»¶æé†’ï¼ˆå¯é€‰ï¼‰</label>
      <input class="modal-inp" id="alertEmail" type="email" placeholder="your@email.com" />
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-confirm" onclick="saveAlert()">ç¡®è®¤æ”¶è—å¹¶è®¾æé†’</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-icon" id="toastIcon"></div>
  <div class="toast-body">
    <div class="toast-title" id="toastTitle"></div>
    <div class="toast-msg" id="toastMsg"></div>
  </div>
</div>

<script>
// â”€â”€â”€ Mock data â”€â”€â”€
const DB = {
  'æœ‰æœºé¸¡è›‹': [
    {p:'jd', name:'å¾·æ¸…æº ç»¿å£³æœ‰æœºé¸¡è›‹ 40æš', price:38.9, orig:45.0, unit:'40æš', delivery:'æ˜æ—¥è¾¾', coupon:'æ»¡30å‡5', certs:['æœ‰æœºè®¤è¯']},
    {p:'mt', name:'ç»¿è‰²å¿ƒæƒ… æœ‰æœºåœŸé¸¡è›‹ 30æš', price:32.9, orig:36.0, unit:'30æš', delivery:'1å°æ—¶', coupon:'æ–°å®¢-6', certs:[]},
    {p:'dd', name:'å®å’šä¼˜é€‰ æœ‰æœºé²œè›‹ 20æš',  price:19.9, orig:22.0, unit:'20æš', delivery:'30åˆ†é’Ÿ', coupon:'', certs:['äº§åœ°ç›´ä¾›']},
    {p:'hm', name:'ç›’é©¬ æ—¥æ—¥é²œæœ‰æœºè›‹ 10æš',  price:12.9, orig:14.9, unit:'10æš', delivery:'1å°æ—¶', coupon:'', certs:[]},
  ],
  'ç‰¹ä»‘è‹ç‰›å¥¶': [
    {p:'jd', name:'è’™ç‰› ç‰¹ä»‘è‹çº¯ç‰›å¥¶ 250mlÃ—24', price:59.9, orig:72.0, unit:'24ç›’', delivery:'æ˜æ—¥è¾¾', coupon:'æ»¡60å‡10', certs:['å“ç‰Œç›´è¥']},
    {p:'mt', name:'ä¼Šåˆ© é‡‘å…¸æ•´ç®± 250mlÃ—12', price:38.8, orig:48.0, unit:'12ç›’', delivery:'30åˆ†é’Ÿ', coupon:'ç«‹å‡5', certs:[]},
    {p:'dd', name:'å…‰æ˜ ä¼˜å€é²œç‰›å¥¶ 950ml',   price:18.9, orig:22.5, unit:'1ç“¶', delivery:'æ˜æ—©7ç‚¹', coupon:'', certs:['ä½æ¸©å†·é“¾']},
    {p:'hm', name:'ç›’é©¬ æ—¥æ—¥é²œçº¯ç‰›å¥¶ 1L',    price:15.9, orig:18.0, unit:'1L', delivery:'2å°æ—¶', coupon:'', certs:['ç°æŒ¤æ–°é²œ']},
  ],
  'æŒªå¨ä¸‰æ–‡é±¼': [
    {p:'jd', name:'æŒªå¨è¿›å£ä¸‰æ–‡é±¼åˆºèº« 500g', price:89.0, orig:108.0,unit:'500g', delivery:'æ¬¡æ—¥è¾¾', coupon:'', certs:['è¿›å£æº¯æº']},
    {p:'mt', name:'æ–°é²œå¤§è¥¿æ´‹ä¸‰æ–‡é±¼ 400g',  price:79.9, orig:95.0, unit:'400g', delivery:'1å°æ—¶', coupon:'æ»¡80å‡8', certs:[]},
    {p:'dd', name:'å®å’šå³åˆ‡ä¸‰æ–‡é±¼åˆºèº« 300g',price:62.9, orig:75.0, unit:'300g', delivery:'30åˆ†é’Ÿ', coupon:'æ–°å®¢ç«‹å‡', certs:[]},
    {p:'hm', name:'ç›’é©¬ å¸ç‹ä¸‰æ–‡é±¼ 250g/ä»½',price:58.0, orig:68.0, unit:'250g', delivery:'1å°æ—¶', coupon:'', certs:['é—¨åº—ç°åˆ‡']},
  ],
  'çŒªè‚‰é‡Œè„Š': [
    {p:'jd', name:'å£¹å·åœŸçŒªé‡Œè„Šè‚‰ 500g å†·å†»',price:45.0, orig:52.0, unit:'500g', delivery:'æ¬¡æ—¥è¾¾', coupon:'', certs:['æ”¾å…»æº¯æº']},
    {p:'mt', name:'æ–°é²œçŒªé‡Œè„Š 500gï¼ˆç°åˆ‡ï¼‰', price:28.8, orig:35.0, unit:'500g', delivery:'30åˆ†é’Ÿ', coupon:'æ»¡30å‡3', certs:[]},
    {p:'dd', name:'å®å’šç²¾é€‰çŒªé‡Œè„Š 400g',    price:22.9, orig:26.0, unit:'400g', delivery:'30åˆ†é’Ÿ', coupon:'', certs:['å†·é“¾å“æ§']},
    {p:'hm', name:'ç›’é©¬æœ‰æœºçŒªé‡Œè„Š 300g/ç›’', price:31.9, orig:38.0, unit:'300g', delivery:'2å°æ—¶', coupon:'', certs:['æœ‰æœºè®¤è¯']},
  ],
  'ä¸¹ä¸œè‰è“': [
    {p:'jd', name:'ä¸¹ä¸œä¹ä¹è‰è“ 2æ–¤ ç¤¼ç›’',  price:59.9, orig:75.0, unit:'1kg', delivery:'æ¬¡æ—¥è¾¾', coupon:'æ»¡60å‡5', certs:['äº§åœ°ç›´å‘']},
    {p:'mt', name:'æ–°é²œå¥¶æ²¹è‰è“ 500g',       price:29.9, orig:38.0, unit:'500g', delivery:'1å°æ—¶', coupon:'', certs:['å½“æ—¥é‡‡æ‘˜']},
    {p:'dd', name:'å®å’šä¸¹ä¸œè‰è“ 500g',       price:24.9, orig:32.0, unit:'500g', delivery:'30åˆ†é’Ÿ', coupon:'æ–°å®¢-5', certs:['äº§åœ°ç›´é‡‡']},
    {p:'hm', name:'ç›’é©¬æœ‰æœºè‰è“ 300g/ç›’',   price:35.0, orig:42.0, unit:'300g', delivery:'2å°æ—¶', coupon:'', certs:['æœ‰æœºå†·è—']},
  ],
  'çŸ¿æ³‰æ°´': [
    {p:'jd', name:'å†œå¤«å±±æ³‰çŸ¿æ³‰æ°´ 500mlÃ—24', price:24.9, orig:29.0, unit:'24ç“¶', delivery:'æ˜æ—¥è¾¾', coupon:'æ»¡25å‡3', certs:['å“ç‰Œç›´è¥']},
    {p:'mt', name:'æ€¡å®çº¯å‡€æ°´ 550mlÃ—24',     price:18.9, orig:22.0, unit:'24ç“¶', delivery:'45åˆ†é’Ÿ', coupon:'', certs:[]},
    {p:'dd', name:'ç™¾å²å±±çŸ¿æ³‰æ°´ 570mlÃ—12',   price:21.9, orig:25.0, unit:'12ç“¶', delivery:'30åˆ†é’Ÿ', coupon:'', certs:['å¤©ç„¶çŸ¿æ³‰']},
    {p:'hm', name:'ç›’é©¬å¤©ç„¶æ°´ 900mlÃ—4',      price:16.9, orig:19.0, unit:'4ç“¶', delivery:'1å°æ—¶', coupon:'', certs:['è‡ªæœ‰å“ç‰Œ']},
  ],
  'è“è“': [
    {p:'jd', name:'æ™ºåˆ©è¿›å£è“è“ 125gÃ—6ç›’',  price:69.9, orig:85.0, unit:'750g', delivery:'æ¬¡æ—¥è¾¾', coupon:'', certs:['è¿›å£ç›´é‡‡']},
    {p:'mt', name:'æ–°é²œè“è“ 125gÃ—4',         price:38.9, orig:48.0, unit:'500g', delivery:'1å°æ—¶', coupon:'æ»¡40å‡4', certs:[]},
    {p:'dd', name:'å®å’šä¼˜é€‰è“è“ 125gÃ—3',    price:28.9, orig:35.0, unit:'375g', delivery:'30åˆ†é’Ÿ', coupon:'', certs:['å½“æ—¥é²œ']},
    {p:'hm', name:'ç›’é©¬ æœ‰æœºè“è“ 125g',     price:19.9, orig:24.0, unit:'125g', delivery:'2å°æ—¶', coupon:'', certs:['æœ‰æœºè®¤è¯']},
  ],
};

const PM = {
  jd:  {name:'äº¬ä¸œè‡ªè¥', short:'äº¬ä¸œ', cls:'jd', color:'#c8341a', hex:'#c8341a', textDark:false, appOnly:false},
  mt:  {name:'ç¾å›¢é—ªè´­', short:'ç¾å›¢', cls:'mt', color:'#f5a800', hex:'#f5a800', textDark:true,  appOnly:true},
  dd:  {name:'å®å’šä¹°èœ', short:'å®å’š', cls:'dd', color:'#1677ff', hex:'#1677ff', textDark:false, appOnly:true},
  hm:  {name:'ç›’é©¬é²œç”Ÿ', short:'ç›’é©¬', cls:'hm', color:'#e63312', hex:'#e63312', textDark:false, appOnly:true},
};

// å„å¹³å°è·³è½¬ç­–ç•¥è¯´æ˜ï¼š
// äº¬ä¸œï¼šæœ‰å®Œæ•´PCç½‘é¡µç‰ˆï¼Œsearch.jd.com å¯ç›´æ¥æœç´¢
// ç¾å›¢é—ªè´­ï¼šæ— æ¶ˆè´¹è€…ç½‘é¡µæœç´¢å…¥å£ï¼Œä»…Appå¯ç”¨ï¼Œè·³è½¬è‡³ä¸‹è½½/å¼•å¯¼é¡µ
// å®å’šä¹°èœï¼šæ— PCç½‘é¡µè´­ç‰©ï¼Œè·³è½¬å®˜ç½‘å¼•å¯¼ä¸‹è½½App
// ç›’é©¬é²œç”Ÿï¼šæ— ç‹¬ç«‹ç½‘é¡µè´­ç‰©ï¼Œè·³è½¬å®˜ç½‘å¼•å¯¼ä¸‹è½½App
const URLS = {
  jd: { web: 'https://search.jd.com/Search?keyword=', hasWeb: true },
  mt: { web: 'https://shangou.meituan.com/', hasWeb: false, appNote: 'ç¾å›¢é—ªè´­ä»…æ”¯æŒ App è´­ä¹°ï¼Œè¯·æ‰«ç æˆ–æœç´¢ã€Œç¾å›¢ã€ä¸‹è½½ App' },
  dd: { web: 'https://www.dingdong.com/', hasWeb: false, appNote: 'å®å’šä¹°èœä»…æ”¯æŒ App è´­ä¹°ï¼Œè¯·æœç´¢ã€Œå®å’šä¹°èœã€ä¸‹è½½ App' },
  hm: { web: 'https://www.freshippo.com/', hasWeb: false, appNote: 'ç›’é©¬é²œç”Ÿä»…æ”¯æŒ App è´­ä¹°ï¼Œè¯·æœç´¢ã€Œç›’é©¬ã€ä¸‹è½½ App' },
};

// Watchlist stored in memory
let watchlist = JSON.parse(localStorage.getItem('bjr_watchlist') || '[]');
let currentKw = '';
let currentResults = [];
let chartInstance = null;
let currentChartFilter = 'all';
let alertTarget = null;

// â”€â”€ Generate history data â”€â”€
function genHistory(basePrice, days=30) {
  const hist = [];
  let price = basePrice * (0.95 + Math.random()*0.1);
  for (let i = days; i >= 0; i--) {
    price = price * (0.98 + Math.random() * 0.04);
    price = Math.max(basePrice * 0.8, Math.min(basePrice * 1.3, price));
    const d = new Date(); d.setDate(d.getDate() - i);
    hist.push({ date: `${d.getMonth()+1}/${d.getDate()}`, price: +price.toFixed(1) });
  }
  return hist;
}

// â”€â”€ Fuzzy match â”€â”€
function findData(kw) {
  for (const key of Object.keys(DB)) {
    if (kw.includes(key) || key.includes(kw.slice(0,3))) return { key, rows: DB[key] };
  }
  const base = 15 + Math.random()*40;
  return {
    key: kw,
    rows: ['jd','mt','dd','hm'].map((p,i) => ({
      p, name: `${['å“è´¨','ä¼˜é€‰','æ–°é²œ','æœ‰æœº'][i]}${kw}`,
      price: +(base*(0.8+Math.random()*0.5)).toFixed(1),
      orig: +(base*1.25).toFixed(1),
      unit: '500g', delivery:['æ˜æ—¥è¾¾','1å°æ—¶','30åˆ†é’Ÿ','2å°æ—¶'][i],
      coupon:['','æ–°å®¢å‡5','',''][i], certs:[],
    }))
  };
}

// â”€â”€ Search â”€â”€
function qs(kw) { document.getElementById('searchInp').value = kw; doSearch(); }

function doSearch() {
  const kw = document.getElementById('searchInp').value.trim();
  if (!kw) return;
  currentKw = kw;

  show('panelLoading');
  const ids = ['jd','mt','dd','hm'];
  const fill = document.getElementById('loadingFill');
  ids.forEach(id => { document.getElementById('ls-'+id).textContent='ç­‰å¾…ä¸­â€¦'; document.getElementById('ls-'+id).className='loading-status'; });
  fill.style.width = '0%';

  ids.forEach((id, i) => {
    setTimeout(() => {
      document.getElementById('ls-'+id).textContent = 'æŸ¥è¯¢ä¸­â€¦';
      fill.style.width = `${(i+1)*22}%`;
    }, i * 300 + 100);
    setTimeout(() => {
      document.getElementById('ls-'+id).textContent = `å·²è·å– ${2+i} æ¡`;
      document.getElementById('ls-'+id).className = 'loading-status done';
      fill.style.width = `${(i+1)*25}%`;
    }, i * 300 + 550);
  });

  setTimeout(() => {
    fill.style.width = '100%';
    const { key, rows } = findData(kw);
    currentResults = rows;
    renderResults(kw, rows);
  }, 1650);
}

// â”€â”€ Render â”€â”€
function renderResults(kw, rows) {
  const sorted = [...rows].sort((a,b) => a.price - b.price);
  const winner = sorted[0];

  show('panelResults');
  document.getElementById('resKw').innerHTML = `ã€Œ<span>${kw}</span>ã€çš„æ¯”ä»·ç»“æœ`;
  document.getElementById('resMeta').textContent = `å…±å¯¹æ¯” ${rows.length} ä¸ªå¹³å° Â· ${new Date().toLocaleTimeString('zh-CN')} æ›´æ–°`;

  // Platform cards
  document.getElementById('platformCards').innerHTML = sorted.map((r,i) => {
    const m = PM[r.p];
    const isWin = i===0;
    const saved = r.orig > r.price ? (r.orig-r.price).toFixed(1) : null;
    const isWatched = watchlist.some(w=>w.key===kw&&w.p===r.p);
    return `<div class="p-card ${isWin?'winner':''}" id="card-${r.p}">
      <div class="p-card-header">
        <div class="p-logo ${r.p}">${m.short}</div>
        <div class="p-name">${m.name}</div>
      </div>
      <div class="p-price-main ${isWin?'lowest':''}"><span class="sym">Â¥</span>${r.price}</div>
      ${r.orig > r.price ? `<div class="p-original">Â¥${r.orig} ${saved?`<span style="color:var(--green);text-decoration:none">çœÂ¥${saved}</span>`:''}  </div>` : ''}
      <div class="p-product-name">${r.name}</div>
      <div class="p-tags">
        ${r.delivery?`<span class="tag tag-speed">âš¡ ${r.delivery}</span>`:''}
        ${r.coupon?`<span class="tag tag-coupon">ğŸ· ${r.coupon}</span>`:''}
        ${r.certs.map(c=>`<span class="tag tag-cert">âœ“ ${c}</span>`).join('')}
      </div>
      <div class="p-footer">
        <button class="p-buy-btn" onclick="openBuy('${r.p}','${kw}')">${URLS[r.p].hasWeb ? 'ç½‘é¡µè´­ä¹°' : 'ğŸ“± App è´­ä¹°'}</button>
        <button class="p-watch-btn ${isWatched?'watching':''}" id="wb-${r.p}" onclick="toggleWatch('${kw}','${r.p}',${r.price})">
          ${isWatched?'â˜…':'â˜†'}
        </button>
      </div>
    </div>`;
  }).join('');

  // Deal box
  const m = PM[winner.p];
  const savedWin = winner.orig > winner.price ? (winner.orig-winner.price).toFixed(1) : null;
  document.getElementById('dealBox').innerHTML = `
    <div class="deal-box-label">å…¨ç½‘æœ€ä½ä»·</div>
    <div class="deal-price"><span class="sym">Â¥</span>${winner.price}</div>
    ${savedWin ? `<div class="deal-saving">â†“ æ¯”åŸä»·èŠ‚çœ Â¥${savedWin}</div>` : '<div style="height:20px"></div>'}
    <div class="deal-platform">
      <div class="deal-platform-badge" style="background:${m.color};">${m.name}</div>
    </div>
    <div class="deal-name">${winner.name}</div>
    <button class="deal-cta" onclick="openBuy('${winner.p}','${kw}')">â†’ å‰å¾€ ${m.name} è´­ä¹°</button>`;

  // Bars
  const maxP = Math.max(...sorted.map(r=>r.price));
  document.getElementById('barsContent').innerHTML = sorted.map((r,i) => {
    const m2 = PM[r.p];
    const pct = Math.round((r.price/maxP)*78+10);
    const isDark = m2.textDark;
    return `<div class="bar-row">
      <div class="bar-plat ${r.p==='mt'?'mt-bar':''}" style="background:${m2.color};color:${isDark?'#5a3800':'#fff'}">${m2.short}</div>
      <div class="bar-track">
        <div class="bar-fill ${r.p==='mt'?'mt-fill':''} ${i===0?'winner-fill':''}"
          style="width:0%;background:${m2.color};color:${isDark?'#5a3800':'#fff'}"
          data-w="${pct}%">Â¥${r.price}</div>
      </div>
    </div>`;
  }).join('');
  setTimeout(() => { document.querySelectorAll('.bar-fill').forEach(el=>{ el.style.width=el.dataset.w; }); }, 60);

  // Chart
  renderChart('all', rows, kw);
}

// â”€â”€ Chart â”€â”€
function renderChart(filter, rows, kw) {
  const canvas = document.getElementById('priceChart');
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const days = 30;
  const dateLabels = [];
  for (let i=days; i>=0; i--) {
    const d=new Date(); d.setDate(d.getDate()-i);
    dateLabels.push(`${d.getMonth()+1}/${d.getDate()}`);
  }

  const toShow = filter==='all' ? rows : rows.filter(r=>r.p===filter);
  const datasets = toShow.map(r => {
    const m = PM[r.p];
    const hist = genHistory(r.price, days);
    return {
      label: m.name,
      data: hist.map(h=>h.price),
      borderColor: m.color,
      backgroundColor: m.color+'22',
      borderWidth: 2,
      pointRadius: 0,
      pointHoverRadius: 4,
      tension: 0.3,
      fill: filter!=='all',
    };
  });

  chartInstance = new Chart(canvas, {
    type: 'line',
    data: { labels: dateLabels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: filter==='all', position:'top', labels:{ font:{size:11}, boxWidth:12, padding:12 } },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: Â¥${ctx.parsed.y.toFixed(1)}`
          }
        }
      },
      scales: {
        x: {
          grid: { display:false },
          ticks: { font:{size:10}, maxTicksLimit:8, color:'#7a7a85' }
        },
        y: {
          grid: { color:'rgba(26,26,30,0.05)' },
          ticks: { font:{size:10}, color:'#7a7a85', callback: v=>`Â¥${v}` }
        }
      }
    }
  });
}

function switchChart(filter, el) {
  document.querySelectorAll('.ctab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  currentChartFilter = filter;
  renderChart(filter, currentResults, currentKw);
}

// â”€â”€ Watch / Alert â”€â”€
function toggleWatch(kw, platform, price) {
  const idx = watchlist.findIndex(w=>w.key===kw&&w.p===platform);
  if (idx > -1) {
    watchlist.splice(idx, 1);
    saveWatchlist();
    updateWatchBtn(platform, false);
    renderSidebarWatchlist();
    toast('ğŸ—‘', 'å·²å–æ¶ˆæ”¶è—', `${PM[platform].name} Â· ${kw}`);
    return;
  }
  // Open alert modal
  alertTarget = { kw, p: platform, price };
  document.getElementById('alertModalSub').textContent = `${PM[platform].name}ï¼šÂ¥${price}ï¼ˆ${kw}ï¼‰`;
  document.getElementById('alertPrice').value = (price * 0.9).toFixed(1);
  document.getElementById('alertEmail').value = '';
  document.getElementById('alertModal').classList.add('show');
}

function closeModal() { document.getElementById('alertModal').classList.remove('show'); alertTarget=null; }

function saveAlert() {
  if (!alertTarget) return;
  const targetP = parseFloat(document.getElementById('alertPrice').value);
  const email = document.getElementById('alertEmail').value;
  const item = { ...alertTarget, targetPrice: targetP||null, email: email||null, savedAt: Date.now() };
  watchlist.push(item);
  saveWatchlist();
  updateWatchBtn(alertTarget.p, true);
  renderSidebarWatchlist();
  closeModal();
  const alertInfo = targetP ? `ç›®æ ‡ä»· Â¥${targetP}` : 'å·²æ”¶è—';
  toast('â­', `æ”¶è—æˆåŠŸ`, `${PM[alertTarget.p].name} Â· ${alertInfo}`);
}

function updateWatchBtn(platform, watching) {
  const btn = document.getElementById('wb-'+platform);
  if (!btn) return;
  btn.className = 'p-watch-btn' + (watching?' watching':'');
  btn.textContent = watching ? 'â˜…' : 'â˜†';
}

function saveWatchlist() {
  try { localStorage.setItem('bjr_watchlist', JSON.stringify(watchlist)); } catch(e){}
}

function renderSidebarWatchlist() {
  const container = document.getElementById('sidebarWatchlist');
  document.getElementById('watchCount').textContent = `(${watchlist.length})`;

  if (watchlist.length === 0) {
    container.innerHTML = '<div class="watchlist-empty">æš‚æ— æ”¶è—å•†å“<br>ç‚¹å‡» â˜† æ”¶è—å•†å“<br>å¯è®¾ç½®åˆ°ä»·æé†’</div>';
    return;
  }

  container.innerHTML = watchlist.map((w,i) => {
    const m = PM[w.p];
    const isAlert = w.targetPrice && w.price <= w.targetPrice;
    return `<div class="watch-item" onclick="qs('${w.key}')">
      ${w.targetPrice ? `<div class="watch-item-alert" title="åˆ°ä»·æé†’å·²è®¾ç½®">ğŸ””</div>` : ''}
      <div class="watch-item-name">${w.key}</div>
      <div class="watch-item-price">Â¥${w.price}</div>
      <div class="watch-item-meta">${m.name}${w.targetPrice?` Â· æé†’<Â¥${w.targetPrice}`:''}</div>
      <div class="watch-remove" onclick="removeWatch(event,${i})">ç§»é™¤</div>
    </div>`;
  }).join('');
}

function removeWatch(e, i) {
  e.stopPropagation();
  watchlist.splice(i,1);
  saveWatchlist();
  renderSidebarWatchlist();
  toast('ğŸ—‘','å·²ç§»é™¤æ”¶è—','');
}

function openBuy(platform, kw) {
  const u = URLS[platform];
  if (u.hasWeb) {
    window.open(u.web + encodeURIComponent(kw), '_blank');
    toast('ğŸ”—', 'æ­£åœ¨è·³è½¬äº¬ä¸œâ€¦', 'å·²æ‰“å¼€äº¬ä¸œç½‘é¡µæœç´¢');
  } else {
    showAppGuide(platform, kw);
  }
}

function showAppGuide(platform, kw) {
  const m = PM[platform];
  const u = URLS[platform];
  const overlay = document.createElement('div');
  overlay.className = 'app-guide-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(26,26,30,0.55);backdrop-filter:blur(4px);z-index:500;display:flex;align-items:center;justify-content:center;';
  const platColor = m.color;
  const textCol = platform === 'mt' ? '#5a3800' : '#fff';
  overlay.innerHTML = `<div style="background:#fff;border-radius:16px;padding:28px;width:340px;box-shadow:0 8px 40px rgba(0,0,0,0.18);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:${textCol};background:${platColor};flex-shrink:0">${m.short}</div>
      <div>
        <div style="font-size:16px;font-weight:700;">${m.name}</div>
        <div style="font-size:11px;color:#7a7a85;">ä»…æ”¯æŒ App ç«¯è´­ä¹°</div>
      </div>
    </div>
    <div style="background:#f5f4ef;border-radius:10px;padding:14px;margin-bottom:16px;">
      <div style="font-size:11px;color:#7a7a85;margin-bottom:4px;">æœç´¢å•†å“</div>
      <div style="font-size:15px;font-weight:700;">${kw}</div>
    </div>
    <div style="font-size:13px;color:#7a7a85;line-height:1.8;margin-bottom:18px;">${u.appNote}</div>
    <div style="display:flex;gap:10px;">
      <button onclick="document.querySelector('.app-guide-overlay').remove()" style="flex:1;padding:11px;border:1.5px solid #e5e3d8;border-radius:8px;background:transparent;font-size:13px;cursor:pointer;">å…³é—­</button>
      <button onclick="window.open('${u.web}','_blank');document.querySelector('.app-guide-overlay').remove()" style="flex:2;padding:11px;background:#1a1a1e;border:none;border-radius:8px;font-size:13px;font-weight:700;color:#fff;cursor:pointer;">æ‰“å¼€å®˜ç½‘</button>
    </div>
  </div>`;
  overlay.addEventListener('click', e => { if(e.target===overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}

// â”€â”€ Utils â”€â”€
function show(id) {
  ['panelWelcome','panelLoading','panelResults'].forEach(p => {
    document.getElementById(p).classList.remove('active');
  });
  document.getElementById(id).classList.add('active');
}

function toast(icon, title, msg) {
  const el = document.getElementById('toast');
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMsg').textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 3000);
}

// â”€â”€ Init â”€â”€
document.getElementById('searchInp').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
renderSidebarWatchlist();
</script>
</body>
</html>
